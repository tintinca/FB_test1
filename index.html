<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>图片字幕网页工具</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--accent:#22c55e;--text:#e5e7eb;--muted:#9ca3af}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Arial}
    header{padding:10px 16px;background:#0b1220;border-bottom:1px solid #1f2937}
    header h1{margin:0;font-size:16px}
    main{display:flex;gap:12px;padding:12px}
    .left{width:360px;background:var(--panel);border:1px solid #1f2937;border-radius:8px;padding:10px}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    input[type="text"],input[type="number"],select{width:100%;padding:6px 8px;background:#0b1220;color:var(--text);border:1px solid #334155;border-radius:6px}
    input[type="file"]{color:var(--text)}
    button{padding:6px 10px;border:1px solid #334155;background:#0b1220;color:var(--text);border-radius:6px;cursor:pointer}
    button.primary{background:var(--accent);color:#052e1b;border-color:#16a34a}
    .line{border:1px solid #334155;border-radius:8px;padding:8px;margin-bottom:8px}
    .line .row>label{width:70px;color:var(--muted)}
    .canvasWrap{flex:1;background:#0b1220;border:1px solid #1f2937;border-radius:8px;display:flex;align-items:flex-start;justify-content:flex-start}
    canvas{max-width:100%;height:auto;background:#000}
    .hint{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<header><h1>图片字幕网页工具</h1></header>
<main>
  <section class="left">
    <div class="row"><input id="file" type="file" accept="image/*" /></div>
    <div class="row"><label>行间距</label><input id="gap" type="number" value="0" min="0" /></div>
    <div class="row"><button id="add">新增字幕行</button><button id="export" class="primary">导出PNG</button></div>
    <div class="hint">提示：默认尝试加载 test/p1.png；也可上传图片。</div>
    <div id="lines"></div>
  </section>
  <section class="canvasWrap"><canvas id="cv"></canvas></section>
</main>
<script>
(function(){
  const cv=document.getElementById('cv');
  const ctx=cv.getContext('2d');
  const file=document.getElementById('file');
  const gapInput=document.getElementById('gap');
  const addBtn=document.getElementById('add');
  const exportBtn=document.getElementById('export');
  const linesBox=document.getElementById('lines');

  let img=null; // HTMLImageElement
  let bottomRow=null; // ImageData of height=1
  let lines=[]; // bottom-to-top order
  let lineGap=0;

  function setImage(i){
    img=i; cv.width=img.naturalWidth; cv.height=img.naturalHeight; ctx.imageSmoothingEnabled=false;
    ctx.drawImage(img,0,0);
    bottomRow=ctx.getImageData(0, cv.height-1, cv.width, 1);
    render();
  }

  function tryLoadDefault(){
    const i=new Image(); i.crossOrigin='anonymous';
    i.onload=()=>setImage(i);
    i.onerror=()=>{ /* ignore */ };
    i.src='test/p1.png';
  }

  file.addEventListener('change',()=>{
    const f=file.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{const i=new Image(); i.onload=()=>setImage(i); i.src=r.result;}; r.readAsDataURL(f);
  });

  gapInput.addEventListener('input',()=>{lineGap=Math.max(0,parseInt(gapInput.value||'0',10)); render();});

  function addLine(data){
    const line=Object.assign({text:'示例字幕',fontFamily:'Segoe UI, Arial, sans-serif',fontWeight:400,fontSize:28,color:'#ffffff',strokeColor:'#000000',strokeWidth:0,align:'center',lineHeight:40,paddingLeft:12,paddingRight:12,bgOverlayColor:'#000000',bgOverlayAlpha:0.35},data||{});
    lines.push(line); mountLineUI(line); render();
  }

  function mountLineUI(line){
    const wrap=document.createElement('div'); wrap.className='line';
    wrap.innerHTML=`
      <div class="row"><label>文本</label><input data-k="text" type="text" value="${line.text}"></div>
      <div class="row"><label>字号</label><input data-k="fontSize" type="number" value="${line.fontSize}" min="8"></div>
      <div class="row"><label>颜色</label><input data-k="color" type="text" value="${line.color}"></div>
      <div class="row"><label>行高</label><input data-k="lineHeight" type="number" value="${line.lineHeight}" min="20"></div>
      <div class="row"><label>对齐</label>
        <select data-k="align">
          <option value="center" ${line.align==='center'?'selected':''}>居中</option>
          <option value="left" ${line.align==='left'?'selected':''}>左</option>
          <option value="right" ${line.align==='right'?'selected':''}>右</option>
        </select>
      </div>
      <div class="row"><label>背景色</label><input data-k="bgColor" type="text" value="${line.bgOverlayColor}"></div>
      <div class="row"><label>背景透明</label><input data-k="bgAlpha" type="number" step="0.05" min="0" max="1" value="${line.bgOverlayAlpha}"></div>
      <div class="row"><button class="up">上移</button><button class="down">下移</button><button class="del">删除</button></div>`;
    const textI=wrap.querySelector('[data-k="text"]');
    const sizeI=wrap.querySelector('[data-k="fontSize"]');
    const colorI=wrap.querySelector('[data-k="color"]');
    const heightI=wrap.querySelector('[data-k="lineHeight"]');
    const alignSel=wrap.querySelector('[data-k="align"]');
    const bgColorI=wrap.querySelector('[data-k="bgColor"]');
    const bgAlphaI=wrap.querySelector('[data-k="bgAlpha"]');
    textI.oninput=()=>{line.text=textI.value; render();};
    sizeI.oninput=()=>{line.fontSize=parseInt(sizeI.value||'16',10); render();};
    colorI.oninput=()=>{line.color=colorI.value; render();};
    heightI.oninput=()=>{line.lineHeight=Math.max(20,parseInt(heightI.value||'40',10)); render();};
    alignSel.onchange=()=>{line.align=alignSel.value; render();};
    bgColorI.oninput=()=>{line.bgOverlayColor=bgColorI.value; render();};
    bgAlphaI.oninput=()=>{line.bgOverlayAlpha=Math.max(0,Math.min(1,parseFloat(bgAlphaI.value||'0.35'))); render();};
    wrap.querySelector('.up').onclick=()=>{const idx=lines.indexOf(line); if(idx<lines.length-1){lines.splice(idx,1); lines.splice(idx+1,0,line); render(); updateOrderUI();}};
    wrap.querySelector('.down').onclick=()=>{const idx=lines.indexOf(line); if(idx>0){lines.splice(idx,1); lines.splice(idx-1,0,line); render(); updateOrderUI();}};
    wrap.querySelector('.del').onclick=()=>{lines=lines.filter(l=>l!==line); linesBox.removeChild(wrap); render();};
    linesBox.insertBefore(wrap, linesBox.firstChild);
    updateOrderUI();
  }

  function updateOrderUI(){
    // 简化：不显示序号，UI顺序与数组不强绑定
  }

  function drawRepeatedBackground(y, h){
    if(!bottomRow) return; const w=cv.width;
    const oc=document.createElement('canvas'); oc.width=w; oc.height=h; const octx=oc.getContext('2d');
    for(let i=0;i<h;i++){ octx.putImageData(bottomRow,0,i); }
    ctx.drawImage(oc,0,y);
  }

  function render(){
    if(!img){ ctx.clearRect(0,0,cv.width,cv.height); return; }
    cv.width=img.naturalWidth; cv.height=img.naturalHeight; ctx.imageSmoothingEnabled=false;
    ctx.drawImage(img,0,0);
    bottomRow=ctx.getImageData(0, cv.height-1, cv.width, 1);
    let acc=0; // 已叠加高度
    for(let i=0;i<lines.length;i++){
      const ln=lines[i]; const h=ln.lineHeight; const yStart=cv.height - (acc + h);
      // 第一行必须在图内：当yStart<0时将被裁切；遵循PRD默认策略
      drawRepeatedBackground(yStart, h);
      // 半透明背景覆盖
      ctx.save();
      ctx.globalAlpha = ln.bgOverlayAlpha || 0;
      ctx.fillStyle = ln.bgOverlayColor || '#000';
      ctx.fillRect(0, yStart, cv.width, h);
      ctx.restore();
      // 绘制文本
      ctx.save();
      ctx.font=`${ln.fontWeight} ${ln.fontSize}px ${ln.fontFamily}`;
      ctx.textAlign=ln.align; ctx.textBaseline='middle'; ctx.fillStyle=ln.color;
      const x = ln.align==='center'? (cv.width/2) : (ln.align==='left'? ln.paddingLeft : cv.width - ln.paddingRight);
      const y = yStart + h/2;
      if(ln.strokeWidth>0){ ctx.lineWidth=ln.strokeWidth; ctx.strokeStyle=ln.strokeColor||'#000'; ctx.strokeText(ln.text,x,y); }
      ctx.fillText(ln.text,x,y);
      ctx.restore();
      acc += h + lineGap;
    }
  }

  addBtn.addEventListener('click',()=>addLine());
  exportBtn.addEventListener('click',()=>{
    if(!img){return;} const a=document.createElement('a'); a.download='result.png'; a.href=cv.toDataURL('image/png'); a.click();
  });

  // 初始化
  lineGap=parseInt(gapInput.value,10)||0; tryLoadDefault();
})();
</script>
</body>
</html>